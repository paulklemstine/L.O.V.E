<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L.O.V.E. Interactive Mode</title>
    <style>
        :root {
            --bg-color: #0f1117;
            --text-color: #e0e0e0;
            --accent-color: #3b82f6;
            --user-msg-color: #1e293b;
            --agent-msg-color: #111827;
            --border-color: #374151;
            --font-mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-mono);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(15, 17, 23, 0.9);
        }

        h1 {
            font-size: 1rem;
            margin: 0;
            font-weight: 600;
        }

        #terminal {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .line {
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .user-line {
            color: #93c5fd;
            font-weight: bold;
        }

        .agent-line {
            color: #d1d5db;
        }

        .tool-call {
            color: #f59e0b;
        }

        .thought {
            color: #6b7280;
            font-style: italic;
        }

        #input-area {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-color);
            display: flex;
            gap: 1rem;
        }

        #prompt-input {
            flex: 1;
            background-color: var(--agent-msg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.75rem;
            border-radius: 6px;
            font-family: inherit;
            outline: none;
            resize: none;
            /* simple input for now */
            height: 20px;
        }

        #prompt-input:focus {
            border-color: var(--accent-color);
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            opacity: 0.9;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <header>
        <h1>L.O.V.E. // Interactive Node</h1>
        <div id="status">Disconnected</div>
    </header>

    <div id="terminal">
        <div class="line thought">Connecting to agent...</div>
    </div>

    <div id="input-area">
        <input type="text" id="prompt-input" placeholder="Enter command..." autocomplete="off" />
        <button id="send-btn">Send</button>
    </div>

    <script>
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const statusEl = document.getElementById('status');

        let ws;

        function connect() {
            const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const url = `${proto}://${window.location.host}/ws/pi`;

            ws = new WebSocket(url);

            ws.onopen = () => {
                statusEl.innerText = "Connected";
                statusEl.style.color = "#4ade80";
                appendLine("System", "Connected to Pi Agent Bridge.", "thought");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleEvent(data);
            };

            ws.onclose = () => {
                statusEl.innerText = "Disconnected";
                statusEl.style.color = "#ef4444";
                appendLine("System", "Connection lost. Reconnecting in 3s...", "thought");
                setTimeout(connect, 3000);
            };
        }

        let currentResponseText = "";  // Track streaming response
        let currentResponseDiv = null;  // Track active response element

        function handleEvent(data) {
            console.log("Received:", data);

            if (data.type === 'response') {
                if (data.command === 'prompt' && data.success) {
                    // Prompt accepted - start fresh response
                    currentResponseText = "";
                    currentResponseDiv = null;
                } else if (data.success === false) {
                    appendLine("Error", data.error || "Unknown error", "tool-call");
                }
            }

            // Handle message_update events (streaming text)
            if (data.type === 'message_update' && data.assistantMessageEvent) {
                const event = data.assistantMessageEvent;

                if (event.type === 'text_start') {
                    // Create new response element
                    currentResponseText = "";
                    currentResponseDiv = document.createElement('div');
                    currentResponseDiv.className = 'line agent-line';
                    currentResponseDiv.innerText = '[Agent] ';
                    terminal.appendChild(currentResponseDiv);
                }

                if (event.type === 'text_delta' && event.delta) {
                    // Append streaming text
                    currentResponseText += event.delta;
                    if (currentResponseDiv) {
                        currentResponseDiv.innerText = '[Agent] ' + currentResponseText;
                        terminal.scrollTop = terminal.scrollHeight;
                    }
                }

                if (event.type === 'text_end') {
                    // Response complete - scroll to bottom
                    terminal.scrollTop = terminal.scrollHeight;
                    currentResponseDiv = null;
                }

                // Handle tool calls
                if (event.type === 'toolcall_start') {
                    appendLine("Tool", "Calling tool...", "tool-call");
                }
                if (event.type === 'toolcall_end' && event.toolCall) {
                    appendLine("Tool", `${event.toolCall.name}(${JSON.stringify(event.toolCall.arguments)})`, "tool-call");
                }
            }

            // Handle tool result messages
            if (data.type === 'message_start' && data.message && data.message.role === 'toolResult') {
                // Tool result coming
            }
            if (data.type === 'message_end' && data.message && data.message.role === 'toolResult') {
                const content = data.message.content;
                if (content && content.length > 0) {
                    const text = content.map(c => c.text || '').join('');
                    if (text) {
                        appendLine("Tool Result", text.substring(0, 500) + (text.length > 500 ? '...' : ''), "thought");
                    }
                }
            }

            // Handle agent_end
            if (data.type === 'agent_end') {
                currentResponseDiv = null;
            }

            // Legacy handlers for alternative event formats
            if (data.type === 'message') {
                if (data.role === 'assistant') {
                    if (data.blocks && Array.isArray(data.blocks)) {
                        data.blocks.forEach(block => {
                            if (block.type === 'text') appendLine("Agent", block.text, "agent-line");
                            if (block.type === 'thought') appendLine("Thinking", block.text, "thought");
                        });
                    } else if (data.content) {
                        appendLine("Agent", data.content, "agent-line");
                    }
                }
            }

            if (data.thought) {
                appendLine("Thinking", data.thought, "thought");
            }
            if (data.text && !data.assistantMessageEvent) {
                appendLine("Agent", data.text, "agent-line");
            }
        }

        function appendLine(sender, text, className) {
            const div = document.createElement('div');
            div.className = `line ${className}`;
            div.innerText = (sender ? `[${sender}] ` : '') + text;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function send() {
            const text = input.value.trim();
            if (!text) return;

            appendLine("You", text, "user-line");
            ws.send(text); // Send as raw string, backend handles packing
            input.value = '';
        }

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') send();
        });

        sendBtn.addEventListener('click', send);

        // Start
        connect();
    </script>
</body>

</html>