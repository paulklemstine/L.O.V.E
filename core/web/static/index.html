<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L.O.V.E. v2 - DeepAgent Control Panel</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --text-color: #e0e0e0;
            --accent-color: #00ffff;
            --secondary-color: #ff00ff;
            --panel-bg: #1a1a1a;
            --success: #00ff00;
            --error: #ff0000;
            --warning: #ffff00;
            --dim-text: #888;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            /* Header, Content, Chat, Logs */
            grid-template-rows: auto 1fr 400px 400px;
            gap: 20px;
            min-height: 100vh;
            height: auto;
            box-sizing: border-box;
            overflow-y: auto;
        }

        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        /* Visuals Base */
        canvas#glcanvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
        }

        canvas#freqcanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 80px;
            height: 100%;
            z-index: 0;
            opacity: 0.5;
            pointer-events: none;
        }

        canvas#notecanvas {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100%;
            z-index: 0;
            opacity: 0.5;
            pointer-events: none;
        }

        #audio-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
        }

        h1 {
            margin: 0;
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
        }

        h2 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            font-size: 1.2em;
            color: var(--secondary-color);
        }

        h3 {
            font-size: 1em;
            margin-bottom: 5px;
            color: var(--accent-color);
        }

        .panel {
            background-color: rgba(26, 26, 26, 0.8);
            /* Semi-transparent */
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #left-sidebar {
            grid-column: 1;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        #main-content {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #right-sidebar {
            grid-column: 3;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* Allow growth */
            height: 100%;
        }

        #status-panel,
        #memory-panel {
            background: var(--panel-bg);
        }

        .stat-item {
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--dim-text);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .running {
            color: var(--success);
        }

        .stopped {
            color: var(--error);
        }

        #goal-display {
            background: #222;
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            margin-top: 5px;
            font-style: italic;
            font-size: 0.9em;
        }

        /* Agent Monitor */
        .agent-card {
            background: #252525;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #444;
        }

        .agent-name {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .agent-status {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .agent-thought {
            font-size: 0.85em;
            color: #aaa;
            font-style: italic;
            border-top: 1px solid #444;
            padding-top: 5px;
            margin-top: 5px;
        }

        /* Art Panel */
        #art-display {
            width: 100%;
            aspect-ratio: 1;
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            overflow: hidden;
        }

        #art-display img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Logs */
        #logs-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #log-container {
            flex-grow: 1;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0d0d0d;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
            font-size: 0.9em;
            display: block;
            /* Ensure visibility */
        }

        #logs-panel {
            /* Remove fixed positioning */
            position: relative;
            grid-column: 1 / -1;
            grid-row: 4;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #333;
            box-shadow: none;
            z-index: 100;
        }

        #logs-panel.collapsed {
            height: 40px;
        }

        #logs-header {
            cursor: pointer;
            padding: 10px;
            background: rgba(40, 40, 40, 0.95);
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #logs-header:hover {
            background: rgba(60, 60, 60, 0.95);
        }

        /* Agent Details */
        .agent-subtasks {
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid #444;
            font-size: 0.85em;
        }

        .agent-subtasks ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        .agent-info {
            margin-top: 5px;
            background: #111;
            padding: 5px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
            color: #ccc;
            overflow-x: auto;
        }

        .log-entry {
            margin-bottom: 4px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #1a1a1a;
            padding-bottom: 2px;
        }

        .log-meta {
            flex-shrink: 0;
            width: 140px;
            font-size: 0.8em;
            color: #666;
            display: flex;
            flex-direction: column;
        }

        .log-content {
            flex-grow: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            /* Fixes long string overflow */
        }

        .log-level {
            font-weight: bold;
        }

        .INFO {
            color: #888;
        }

        .WARNING {
            color: var(--warning);
        }

        .ERROR {
            color: var(--error);
        }

        .source {
            color: var(--accent-color);
        }

        /* Chat Interface */
        #chat-interface {
            grid-column: 1 / -1;
            grid-row: 3;
            background: rgba(21, 21, 21, 0.95);
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        #chat-header {
            padding: 5px 10px;
            background: #222;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #151515;
        }

        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.95em;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: #2a2a2a;
            color: #fff;
            border-top-right-radius: 2px;
            border: 1px solid #444;
        }

        .message.assistant {
            align-self: flex-start;
            background: rgba(0, 255, 255, 0.1);
            color: #d0d0d0;
            border-top-left-radius: 2px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .message.system {
            align-self: center;
            background: #222;
            color: #888;
            font-family: monospace;
            font-size: 0.85em;
            border: 1px dashed #444;
            width: 90%;
            max-width: 90%;
        }

        .message-role {
            font-size: 0.75em;
            margin-bottom: 2px;
            opacity: 0.6;
            font-weight: bold;
        }

        #chat-controls {
            padding: 10px;
            display: flex;
            gap: 10px;
            background: #1a1a1a;
            border-top: 1px solid #333;
        }

        #chat-input {
            flex-grow: 1;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: inherit;
        }

        button#send-btn {
            background: var(--accent-color);
            color: #000;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button#send-btn:hover {
            opacity: 0.9;
        }

        button#send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Interaction Panel */
        .interaction-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
        }

        .interaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .interaction-author {
            font-weight: bold;
            color: var(--secondary-color);
        }

        .interaction-text {
            color: #ddd;
            margin-bottom: 4px;
        }

        .interaction-meta {
            font-size: 0.8em;
            color: #666;
        }

        /* Latest Post Text */
        .latest-post-content {
            margin-top: 10px;
            padding: 10px;
            background: #222;
            border-radius: 4px;
            font-size: 0.9em;
            border-left: 2px solid var(--accent-color);
        }

        .latest-post-stats {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            font-size: 0.8em;
            color: #888;
        }
    </style>
</head>

<body>
    <canvas id="glcanvas"></canvas>
    <canvas id="freqcanvas"></canvas>
    <canvas id="notecanvas"></canvas>

    <header>
        <h1>L.O.V.E. v2 Control Panel</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button id="audio-btn" onclick="initAudio()">ENABLE VISUALS</button>
            <div id="connection-status" style="color: var(--error)">Disconnected</div>
        </div>
    </header>

    <div id="left-sidebar">
        <!-- System Status -->
        <div id="status-panel" class="panel">
            <h2>System Status</h2>
            <div class="stat-item">
                <div class="stat-label">Core State</div>
                <div id="agent-state" class="stat-value stopped">STOPPED</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Iteration</div>
                <div id="iteration-count" class="stat-value">0</div>
            </div>
            <div class="stat-label">Current Goal</div>
            <div id="goal-display">Waiting for goal...</div>
        </div>

        <!-- Active Agents -->
        <div id="agents-panel" class="panel"
            style="flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 300px;">
            <h2>Active Agents</h2>
            <div id="agent-list" style="overflow-y: auto; flex-grow: 1;">
                <div style="color: #666; font-style: italic;">No agents active yet...</div>
            </div>
        </div>

        <!-- Social Graph Stats -->
        <div id="graph-panel" class="panel" style="margin-top: 10px;">
            <h2>Social Graph</h2>
            <div class="stat-item">
                <div class="stat-label">Nodes / Edges</div>
                <div id="graph-size" class="stat-value" style="color: var(--accent-color);">-- / --</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Communities</div>
                <div id="graph-communities" class="stat-value">--</div>
            </div>
            <div class="stat-label">Top Clusters</div>
            <div id="top-communities-list" style="font-size: 0.85em; color: #acc; margin-top: 5px;">
                Waiting for analysis...
            </div>
        </div>
    </div>

    <div id="main-content">
        <!-- Art/Visuals + Latest Post (Moved to Middle) -->
        <div id="art-panel" class="panel"
            style="width: 100%; min-height: 500px; box-sizing: border-box; display: flex; flex-direction: column;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; margin-bottom: 10px; padding-bottom: 5px;">
                <h2 style="border:none; margin:0;">Latest Post</h2>
            </div>

            <div id="art-display" style="flex-grow: 1; min-height: 0; margin-bottom: 10px;">
                <span>No Signal</span>
            </div>
            <div id="latest-post-text" class="latest-post-content" style="display:none; flex-shrink: 0;"></div>
        </div>
    </div>

    <div id="right-sidebar">
        <!-- Interactions Panel (Latest Comments/Replies) -->
        <div id="interactions-panel" class="panel"
            style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
            <h2>Live Comments</h2>
            <div id="interactions-list" style="overflow-y: auto; flex-grow: 1;">
                <div style="color: #666; font-style: italic; padding: 10px;">Waiting for signal...</div>
            </div>
        </div>
    </div>

    <!-- Collapsible Logs Panel -->
    <div id="logs-panel" class="panel collapsed">
        <div id="logs-header" role="button" tabindex="0" aria-expanded="false" aria-controls="log-container" onclick="toggleLogs()" onkeydown="handleHeaderKey(event)">
            <h2 style="margin:0; border:none; font-size:1em;">Live Logs (Click to Toggle)</h2>
            <span id="log-toggle-icon">‚ñ≤</span>
        </div>
        <div id="log-container"></div>
    </div>

    <!-- Chat Interface -->
    <div id="chat-interface">
        <div id="chat-header">
            <span>L.O.V.E. Communication Link</span>
        </div>
        <div id="chat-messages">
            <!-- Messages will appear here -->
            <div style="text-align: center; color: #444; margin-top: 20px;">
                <i>Initiating secure link...</i>
            </div>
        </div>
        <div id="chat-controls">
            <input type="text" id="chat-input" aria-label="Message L.O.V.E." placeholder="Message L.O.V.E..." onkeypress="handleChatEnter(event)">
            <button id="send-btn" onclick="sendMessage()">SEND</button>
        </div>
    </div>

    <script>
        const API_URL = "/api";
        const UPDATE_INTERVAL = 1000;
        let lastImageHash = "";

        async function fetchStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();

                // Connection status
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').style.color = '#00ff00';

                // Core Stats
                document.getElementById('agent-state').textContent = data.is_running ? "RUNNING" : "STOPPED";
                document.getElementById('agent-state').className = `stat-value ${data.is_running ? 'running' : 'stopped'}`;
                document.getElementById('iteration-count').textContent = data.iteration;

                const goal = data.current_goal || "No active goal";
                document.getElementById('goal-display').textContent = goal;

                // Agent List
                updateAgentList(data.agent_states);

                // Art/Image & Latest Post
                // Latest Post (Image + Text)
                if (data.latest_post) {
                    const lp = data.latest_post;

                    const postTextDiv = document.getElementById('latest-post-text');
                    const artDisplay = document.getElementById('art-display');

                    postTextDiv.style.display = 'block';

                    // Render Image if available
                    let imageHtml = '<span>No Image</span>';
                    if (lp.image_url) {
                        imageHtml = `<img src="${lp.image_url}" alt="Post Image" />`;
                    } else if (data.last_image) {
                        // Fallback to last generated image if it matches context, 
                        // but strictly speaking user wants "latest bluesky post".
                        // If the post has no image, we shouldn't show a random generated one.
                        // However, locally we might not have the URL working if it's strict.
                        // Let's trust image_url from Bluesky.
                        imageHtml = '<span style="font-size: 0.8em; color: #555;">(Text only)</span>';
                    }

                    artDisplay.innerHTML = imageHtml;

                    // Render Text
                    postTextDiv.innerHTML = `
                       <div>${escapeHtml(lp.text)}</div>
                       <div class="latest-post-stats">
                           <span>‚ù§Ô∏è ${lp.likes || 0}</span>
                           <span>üîÅ ${lp.reposts || 0}</span>
                           <span>üïí ${new Date(lp.timestamp).toLocaleTimeString()}</span>
                       </div>
                   `;
                } else {
                    // No latest post data yet
                    // Maybe show last_image as placeholder? 
                    // User said: "remove the generate_image tool, the one that was only for the index.html page"
                    // imply removing the preview that isn't the post.
                    // So we do nothing or clear it.
                }

                // Interactions
                if (data.interactions) {
                    updateInteractions(data.interactions);
                }

                // Chat History
                if (data.chat_history) {
                    updateChatMessages(data.chat_history);
                }

            } catch (error) {
                console.error("Status fetch failed:", error);
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').style.color = '#ff0000';
            }
        }

        async function fetchGraphStats() {
            try {
                const response = await fetch(`${API_URL}/graph/stats`);
                const data = await response.json();

                if (data.status === "error" || data.status === "not_ready") {
                    return; // Keep placeholders
                }

                document.getElementById('graph-size').textContent = `${data.node_count} / ${data.edge_count}`;
                document.getElementById('graph-communities').textContent = data.total_communities || 0;

                if (data.top_communities && data.top_communities.length > 0) {
                    const list = data.top_communities.map(c =>
                        `<div style="display:flex; justify-content:space-between;"><span>Family #${c.id}</span><span>${c.count}</span></div>`
                    ).join('');
                    document.getElementById('top-communities-list').innerHTML = list;
                } else {
                    document.getElementById('top-communities-list').innerHTML = '<div style="font-style:italic; color:#666">No clusters detected</div>';
                }
            } catch (e) {
                console.error("Graph stats error", e);
            }
        }

        // Poll stats
        setInterval(fetchStatus, UPDATE_INTERVAL);
        setInterval(fetchGraphStats, 5000); // Top up graph stats every 5s


        function updateAgentList(agentStates) {
            const container = document.getElementById('agent-list');
            if (!agentStates || Object.keys(agentStates).length === 0) {
                return;
            }

            let html = '';
            // Track all agents
            for (const [name, state] of Object.entries(agentStates)) {
                html += `
                    <div class="agent-card">
                        <div class="agent-name">${name}</div>
                        <div class="agent-status">${state.status}</div>
                        ${state.action ? `<div style="color: var(--success); font-size: 0.9em;">‚ñ∂ ${state.action}</div>` : ''}
                        ${state.thought ? `<div class="agent-thought">"${state.thought}"</div>` : ''}
                        
                        ${renderSubtasks(state.subtasks)}
                        ${renderInfo(state.info)}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderSubtasks(subtasks) {
            if (!subtasks || subtasks.length === 0) return '';
            return `
                <div class="agent-subtasks">
                    <div style="color: #888;">Subtasks:</div>
                    <ul>${subtasks.map(t => `<li>${t}</li>`).join('')}</ul>
                </div>
            `;
        }

        function renderInfo(info) {
            if (!info || Object.keys(info).length === 0) return '';
            // Format info nicely
            try {
                const jsonStr = JSON.stringify(info, null, 2);
                return `<div class="agent-info">${jsonStr}</div>`;
            } catch (e) {
                return '';
            }
        }

        function toggleLogs() {
            const panel = document.getElementById('logs-panel');
            const icon = document.getElementById('log-toggle-icon');
            const header = document.getElementById('logs-header');
            panel.classList.toggle('collapsed');
            const isCollapsed = panel.classList.contains('collapsed');
            icon.textContent = isCollapsed ? '‚ñ≤' : '‚ñº';
            header.setAttribute('aria-expanded', !isCollapsed);
        }

        function handleHeaderKey(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleLogs();
            }
        }

        function updateInteractions(interactions) {
            const container = document.getElementById('interactions-list');
            if (!interactions || interactions.length === 0) return;

            // Render list
            container.innerHTML = interactions.map(item => {
                const icon = item.reason === 'reply' ? 'üí¨' : item.reason === 'mention' ? 'üëã' : '‚ù§Ô∏è';
                return `
                    <div class="interaction-item">
                        <div class="interaction-header">
                            <span class="interaction-author">${icon} @${item.author.handle}</span>
                            <span class="interaction-meta">${new Date(item.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="interaction-text">${escapeHtml(item.text || "")}</div>
                    </div>
                `;
            }).join('');
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`${API_URL}/logs?limit=100`);
                const logs = await response.json();

                const container = document.getElementById('log-container');
                const wasScrolledToBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

                // Reverse logs: most recent at top
                container.innerHTML = logs.reverse().map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    return `
                        <div class="log-entry">
                            <div class="log-meta">
                                <div>${time}</div>
                                <div class="log-level ${log.level}">${log.level}</div>
                                <div class="source">${log.source}</div>
                            </div>
                            <div class="log-content">${escapeHtml(log.message)}</div>
                        </div>
                    `;
                }).join('');

                // Scroll only if user was near top (since we're adding to top now? No, we're replacing content)
                // Actually, if reversed, we usually want to see top.
                // But this replaces innerHTML.
                // Standard terminal: new at bottom. "Reverse" means new at top.
                // So scroll should be at TOP (0).
                // container.scrollTop = 0; 
                // However, user might scroll down to see history.
                // Let's leave scroll position alone if not 0.


                if (wasScrolledToBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error("Log fetch failed:", error);
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Chat System
        function toggleChatHeight() {
            const chat = document.getElementById('chat-interface');
            if (chat.style.height === '500px') {
                chat.style.height = '300px';
            } else {
                chat.style.height = '500px';
            }
        }

        function renderMessage(role, content) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${role}`;

            // Convert role for display
            const displayRole = role === 'user' ? 'CREATOR' : 'L.O.V.E.';

            div.innerHTML = `
                <div class="message-role">${displayRole}</div>
                <div class="message-content">${escapeHtml(content)}</div>
            `;
            container.appendChild(div);
            // Auto scroll
            container.scrollTop = container.scrollHeight;
        }

        function updateChatMessages(history) {
            const container = document.getElementById('chat-messages');

            // Only update if length changed or we have no messages
            // This prevents flickering while typing or if we just want a simple refresh
            if (container.children.length === history.length) return;
            if (history.length === 0 && container.innerHTML.includes('Start a conversation')) return;

            container.innerHTML = '';
            history.forEach(msg => {
                renderMessage(msg.role, msg.content);
            });
        }

        async function loadChatHistory() {
            try {
                const response = await fetch(`${API_URL}/chat/history`);
                const history = await response.json();

                const container = document.getElementById('chat-messages');
                container.innerHTML = ''; // Clear loading msg

                if (history.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #444; margin-top: 20px;"><i>Start a conversation...</i></div>';
                } else {
                    history.forEach(msg => {
                        renderMessage(msg.role, msg.content);
                    });
                }
            } catch (e) {
                console.error("Failed to load chat history:", e);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // UI Optimistic update
            renderMessage('user', message);
            input.value = "";
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: message })
                });
                const data = await response.json();

                if (data.error) {
                    renderMessage('assistant', `[ERROR]: ${data.error}`);
                } else {
                    renderMessage('assistant', data.response);
                }
            } catch (e) {
                renderMessage('assistant', `[CONNECTION ERROR]: ${e}`);
            } finally {
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.focus();
            }
        }

        function handleChatEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // Init Chat
        loadChatHistory();

        // Initial load
        fetchStatus();
        fetchLogs();

        // Loop
        setInterval(() => {
            fetchStatus();
            fetchLogs();
        }, UPDATE_INTERVAL);
    </script>
    <script src="/static/visuals.js"></script>
    <script>
        // Init visuals after load
        window.addEventListener('load', () => {
            if (window.initVisuals) window.initVisuals();
        });
    </script>
</body>

</html>