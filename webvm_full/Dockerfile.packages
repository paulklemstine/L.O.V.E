# Packages volume - contains all Python dependencies
# This will be built separately and mounted at /opt/python-packages

# Start from the base image to have the same architecture and tools
FROM i386/debian:bookworm AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install minimal build dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    build-essential \
    curl \
    libffi-dev \
    libjpeg-dev \
    libssl-dev \
    pkg-config \
    gfortran \
    libopenblas-dev \
    liblapack-dev \
    cmake \
    llvm-dev \
    golang-go \
    netcat-openbsd \
    byobu \
    openssh-client \
    openssh-server \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Install Rust for building Python packages that need it
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-host i686-unknown-linux-gnu
ENV PATH="/root/.cargo/bin:${PATH}"
ENV CARGO_BUILD_TARGET=i686-unknown-linux-gnu

# Upgrade pip
RUN linux32 python3 -m pip install --upgrade pip --break-system-packages



# Copy requirements.txt and constraints.txt
COPY requirements.txt /tmp/requirements.txt
COPY constraints.txt /tmp/constraints.txt

# Change to /tmp to avoid any conflicts with source directories
WORKDIR /tmp

# Install all other requirements (excluding torch and transformers which we already installed)
RUN linux32 python3 -m pip install \
    --target=/packages \
    --break-system-packages \
    --constraint /tmp/constraints.txt \
    -r /tmp/requirements.txt

# Final stage - just the packages
FROM scratch
COPY --from=builder /packages /
