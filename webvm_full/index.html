<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>L.O.V.E. WebVM Full Edition (Multi-Volume)</title>
    <script src="https://cxrtnc.leaningtech.com/1.2.2/cx.js"></script>
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #console {
            flex: 1;
            width: 100%;
            overflow: auto;
        }

        #status {
            padding: 10px;
            border-bottom: 1px solid #333;
            color: #888;
        }

        #network-notice {
            padding: 10px;
            background: #ff6600;
            color: #000;
            text-align: center;
            cursor: pointer;
            display: none;
            font-weight: bold;
        }

        #network-notice:hover {
            background: #ff8800;
        }
    </style>
</head>

<body>
    <div id="status">
        Initializing WebVM...
        <button id="paste-btn" style="float: right; margin-left: 10px; padding: 2px 8px; cursor: pointer;">üìã
            Paste</button>
    </div>
    <div id="network-notice">‚ö†Ô∏è Click here to enable networking (Tailscale authentication required)</div>
    <div id="console"></div>
    <script>
        let networkLoginUrl = null;

        async function run() {
            try {
                // Load base system
                document.getElementById('status').innerText = "Loading base system...";
                const baseDevice = await CheerpX.HttpBytesDevice.create("base.ext2");
                const baseOverlay = await CheerpX.OverlayDevice.create(
                    baseDevice,
                    await CheerpX.IDBDevice.create("base_cache")
                );

                // Load packages volume
                document.getElementById('status').innerText = "Loading Python packages...";
                const packagesDevice = await CheerpX.HttpBytesDevice.create("packages.ext2");
                const packagesOverlay = await CheerpX.OverlayDevice.create(
                    packagesDevice,
                    await CheerpX.IDBDevice.create("packages_cache")
                );

                // Load app volume
                document.getElementById('status').innerText = "Loading L.O.V.E application...";
                const appDevice = await CheerpX.HttpBytesDevice.create("app.ext2");
                const appOverlay = await CheerpX.OverlayDevice.create(
                    appDevice,
                    await CheerpX.IDBDevice.create("app_cache")
                );

                document.getElementById('status').innerText = "Initializing CheerpX...";

                // Initialize CheerpX with Tailscale networking
                const cx = await CheerpX.Linux.create({
                    mounts: [
                        { type: "ext2", path: "/", dev: baseOverlay },
                        { type: "ext2", path: "/opt/python-packages", dev: packagesOverlay },
                        { type: "ext2", path: "/root/L.O.V.E", dev: appOverlay },
                        { type: "devs", path: "/dev" },
                        { type: "proc", path: "/proc" }
                    ],
                    networkInterface: {
                        authKey: "",  // Empty for interactive login
                        loginUrlCb: (url) => {
                            networkLoginUrl = url;
                            const notice = document.getElementById('network-notice');
                            notice.style.display = 'block';
                            notice.onclick = () => {
                                window.open(url, "_blank", "width=800,height=600");
                                notice.textContent = "‚úì Authentication window opened - complete login to enable networking";
                                notice.style.background = "#ffaa00";
                            };
                            console.log("Tailscale login URL:", url);
                        },
                        stateUpdateCb: (state) => {
                            console.log('Network state:', state);
                            if (state === 6) {
                                document.getElementById('network-notice').style.display = 'none';
                                document.getElementById('status').innerText = "‚úì Network Connected";
                                "TERM=xterm",
                                    "PYTHONUNBUFFERED=1",
                                    "PYTHONPATH=/opt/python-packages"
                    ],
                cwd: "/root"
            });

            document.getElementById('status').innerText = "Process Finished.";
        } catch (e) {
            document.getElementById('status').innerText = "Error: " + e;
            console.error(e);
        }
        }

        run();
    </script>
</body>

</html>