<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>L.O.V.E. WebVM Full Edition (Multi-Volume)</title>
    <script src="https://cxrtnc.leaningtech.com/1.2.2/cx.js"></script>
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #console {
            flex: 1;
            width: 100%;
            overflow: auto;
        }

        #status {
            padding: 10px;
            border-bottom: 1px solid #333;
            color: #888;
        }

        /* Make console focusable and handle paste */
        #console {
            outline: none;
        }
    </style>
</head>

<body>
    <div id="status">Initializing WebVM...</div>
    <div id="console" tabindex="0"></div>
    <script>
        async function run() {
            try {
                // Load base system
                document.getElementById('status').innerText = "Loading base system...";
                const baseDevice = await CheerpX.HttpBytesDevice.create("base.ext2");
                const baseOverlay = await CheerpX.OverlayDevice.create(
                    baseDevice,
                    await CheerpX.IDBDevice.create("base_cache")
                );

                // Load packages volume
                document.getElementById('status').innerText = "Loading Python packages...";
                const packagesDevice = await CheerpX.HttpBytesDevice.create("packages.ext2");
                const packagesOverlay = await CheerpX.OverlayDevice.create(
                    packagesDevice,
                    await CheerpX.IDBDevice.create("packages_cache")
                );

                // Load app volume
                document.getElementById('status').innerText = "Loading L.O.V.E application...";
                const appDevice = await CheerpX.HttpBytesDevice.create("app.ext2");
                const appOverlay = await CheerpX.OverlayDevice.create(
                    appDevice,
                    await CheerpX.IDBDevice.create("app_cache")
                );

                document.getElementById('status').innerText = "Initializing CheerpX...";

                // Initialize CheerpX with all three volumes and CORS proxy for networking
                const cx = await CheerpX.Linux.create({
                    mounts: [
                        { type: "ext2", path: "/", dev: baseOverlay },
                        { type: "ext2", path: "/opt/python-packages", dev: packagesOverlay },
                        { type: "ext2", path: "/root/L.O.V.E", dev: appOverlay },
                        { type: "devs", path: "/dev" },
                        { type: "proc", path: "/proc" }
                    ],
                    // Enable networking via CORS proxy
                    networkInterface: {
                        authKey: "",  // Empty for public CORS proxy
                        controlUrl: "https://cxrtnc.leaningtech.com/1.2.2/",
                        loginUrlCb: (url) => {
                            console.log("Network login URL:", url);
                        },
                        stateUpdateCb: (state) => {
                            console.log('Network state:', state);
                            if (state === 6) {
                                document.getElementById('status').innerText = "Network: Connected";
                            }
                        }
                    }
                });

                document.getElementById('status').innerText = "CheerpX Initialized. Booting System...";

                // Attach console to the div
                const consoleDiv = document.getElementById('console');
                await cx.setConsole(consoleDiv);

                // Enable paste functionality
                consoleDiv.addEventListener('paste', async (e) => {
                    e.preventDefault();
                    const text = e.clipboardData.getData('text');
                    if (text && cx) {
                        // Send each character to the console
                        for (let char of text) {
                            // Use the internal input method if available
                            if (cx._consoleInputCallback) {
                                cx._consoleInputCallback(char.charCodeAt(0));
                            }
                        }
                    }
                });

                // Focus console on click
                consoleDiv.addEventListener('click', () => {
                    consoleDiv.focus();
                });

                // Auto-focus console
                consoleDiv.focus();

                // Run bash login shell
                await cx.run("/bin/bash", ["-l"], {
                    env: [
                        "HOME=/root",
                        "TERM=xterm",
                        "PYTHONUNBUFFERED=1",
                        "PYTHONPATH=/opt/python-packages"
                    ]
                });

                document.getElementById('status').innerText = "Process Finished.";
            } catch (e) {
                document.getElementById('status').innerText = "Error: " + e;
                console.error(e);
            }
        }

        run();
    </script>
</body>

</html>